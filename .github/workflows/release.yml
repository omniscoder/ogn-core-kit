name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  version-consistency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract tag version
        id: tag
        run: |
          set -euo pipefail
          ref="${GITHUB_REF##*/}"
          echo "tag=${ref#v}" >> "$GITHUB_OUTPUT"

      - name: Check Python package version
        run: |
          set -euo pipefail
          pyv="$(sed -n 's/^version *= *"\\(.*\\)".*/\\1/p' sdk/python/pyproject.toml | head -n1)"
          if [[ -z "${pyv}" ]]; then
            echo "::error::Could not parse version from sdk/python/pyproject.toml"
            exit 1
          fi
          test "${pyv}" = "${{ steps.tag.outputs.tag }}" || {
            echo "::error::sdk/python version (${pyv}) != tag (${{
              steps.tag.outputs.tag
            }})"
            exit 1
          }

      - name: Check Rust crate version
        run: |
          set -euo pipefail
          rustv="$(sed -n 's/^version *= *"\\(.*\\)".*/\\1/p' sdk/rust/ogn-sdk/Cargo.toml | head -n1)"
          if [[ -z "${rustv}" ]]; then
            echo "::error::Could not parse version from sdk/rust/ogn-sdk/Cargo.toml"
            exit 1
          fi
          test "${rustv}" = "${{ steps.tag.outputs.tag }}" || {
            echo "::error::sdk/rust crate version (${rustv}) != tag (${{
              steps.tag.outputs.tag
            }})"
            exit 1
          }

  python-build:
    runs-on: ubuntu-latest
    needs: version-consistency
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build wheel + sdist
        working-directory: sdk/python
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip build twine
          python -m build
          twine check dist/*

      - uses: actions/upload-artifact@v4
        with:
          name: pypi-dist
          path: sdk/python/dist/*

  rust-package:
    runs-on: ubuntu-latest
    needs: version-consistency
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Cargo package
        working-directory: sdk/rust/ogn-sdk
        run: |
          set -euxo pipefail
          cargo package --no-verify

  publish-pypi:
    runs-on: ubuntu-latest
    needs: python-build
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && secrets.PYPI_API_TOKEN != '' }}
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build wheel + sdist
        working-directory: sdk/python
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip build
          python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: sdk/python/dist

  publish-crates:
    runs-on: ubuntu-latest
    needs: rust-package
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') && secrets.CRATES_IO_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Cargo publish ogn-sdk
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        working-directory: sdk/rust/ogn-sdk
        run: |
          set -euxo pipefail
          cargo publish --no-verify
